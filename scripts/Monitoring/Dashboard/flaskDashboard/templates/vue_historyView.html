<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <!-- axios for AJAX calls-->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- include VueJS  -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <!-- use the latest vue-select release -->

    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <!-- Vuetify dependencies-->
    <link href="https://fonts.googleapis.com/css?family=Material+Icons" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <!-- day.js manipulating timestamps -->
    <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
   
    <!-- Plotly library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!-- custom css -->
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>History/{{ ID }}</title>
</head>

<body>
    <div id="app">
        <v-app>
            <v-main>
                <v-card>
                    <v-card-title>
                        <v-spacer></v-spacer>
                        <v-btn icon @click="previous_histo" :disabled="c_left_disabled">
                            <v-icon> mdi-arrow-left-thick </v-icon>
                        </v-btn>
                        <v-btn icon @click="next_histo" :disabled="c_right_disabled">
                            <v-icon>mdi-arrow-right-thick</v-icon>
                        </v-btn>
                        <v-select dense outlined flat hide-details :items="c_timestamps" v-model="c_selected">
                            <template v-slot:item="{ item }">
                                [[ item | timestampDisplay ]]
                            </template>
                            <template v-slot:selection="{ item }">
                                [[ item | timestampDisplay ]]
                            </template>
                        </v-select>
                        <v-spacer></v-spacer>
                    </v-card-title>
                    <v-divider></v-divider>
                    <v-card-text class="card_histo_cont">
                        <plotly-graph v-if="c_figure" :figure="c_figure" :divid="c_ID"></plotly-graph>
                    </v-card-text>
                </v-card>
            </v-main>
        </v-app>
    </div>
    <script src="{{ url_for('static', filename = 'js/plotly_component.js') }}"> </script>
    <script>
        const EventBus = new Vue();


        ////////////// Main Component //////////////
        var app = new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data: {
                c_ID: "{{ ID | safeÂ }}",
                c_timestamps: [],
                c_selected: null,
                c_left_disabled: false,
                c_right_disabled: true,
                c_figure: null
            },
            delimiters: ["[[", "]]"],
            computed: {

            },
            filters: {
                timestampDisplay: function (timestamp) {
                    if (timestamp.includes("old")) {
                        return "old:" + dayjs.unix(timestamp.slice(4)).format("HH:mm:ss (MM/DD)")
                    } else {
                        return dayjs.unix(timestamp).format("HH:mm:ss (MM/DD)")
                    }
                }
            },
            created() {

            },
            watch: {
                c_selected: function (value) {
                    const index = this.c_timestamps.indexOf(value)

                    if (index == 0) {
                        this.c_right_disabled = true
                        this.c_left_disabled = false
                    } else if (index == this.c_timestamps.length - 1) {
                        this.c_left_disabled = true
                        this.c_right_disabled = false
                    } else {
                        this.c_left_disabled = false
                        this.c_right_disabled = false
                    }

                    axios.get('/stored_histogram', {
                            params: {
                                ID: this.c_ID,
                                timestamp: value
                            }
                        })
                        .then(response => {
                            console.log(response.data)
                            this.c_figure = response.data["figure"]
                        })
                }
            },

            mounted() {
                axios.get('/stored_timestamps?ID={{ ID }}')
                    .then(response => {
                        this.c_timestamps = response.data["ts"].concat(response.data["ots"])
                        this.c_selected = this.c_timestamps[0]
                    })
            },
            methods: {
                next_histo() {
                    const index = this.c_timestamps.indexOf(this.c_selected)
                    this.c_selected = this.c_timestamps[index - 1]

                },

                previous_histo() {
                    const index = this.c_timestamps.indexOf(this.c_selected)
                    this.c_selected = this.c_timestamps[index + 1]
                }
            },
        });
    </script>
</body>

</html>
