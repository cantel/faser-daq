<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script> -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js" integrity="sha512-iqRVtNB+t9O+epcgUTIPF+nklypcR23H1yR1NFM9kffn6/iBhZ9bTB6oKLaGMv8JE9UgjcwfBFg/eHC/VMws+g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" defer></script>
  <script src="{{  url_for('static', filename = 'js/info_panel.js')  }}" defer></script>
  <script src="{{ url_for('static', filename = 'js/main.js') }}" defer></script>
  <script src="https://cdn.plot.ly/plotly-cartesian-2.9.0.min.js"></script>
  <!-- <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet"> -->

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui" />
  <title>Run Control</title>
  <style>
    .treeview {
      font-size: small;
    }


    .scrollableDiv {
      height: 200px;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .metrics-panel {
      width: 25%;
      min-width: max-content;
      max-width: 205px;
      margin-top: 10px;
      margin-left: 15px;
      margin-right: 15px;
      padding: 4px;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div id="app">
    <v-app dark>
      <v-navigation-drawer v-model="drawer" :permanent="false" app width="300">
        <h3 class="my-4 text-center"> Tree View </h3>
        <v-treeview :hoverable="true" return-object open-all class="treeview" @update:active="setActiveNode"
          v-if="nodeStates" item-key="name" activatable selection-type="independent" dense :items="[c_treeJson]">
          <template v-slot:prepend="{ item,open }">
            <v-icon v-if="modulesError.includes(item.name)" color="error">
              mdi-alert-circle
            </v-icon>
            <v-tooltip open-delay="200" dark top :color="stateColors[getNodeState(item.name)]">
              <template v-slot:activator="{ on, attrs }">
                <v-icon v-bind="attrs" v-on="on" :color="stateColors[getNodeState(item.name)]">
                  mdi-circle
                </v-icon>
              </template>
              <span> [[getNodeState(item.name)]]</span>
            </v-tooltip>
          </template>
          <template v-slot:label="{ item, selected, active }">
            <div style="display:flex;align-items: center;">
              <span :class="{'red lighten-3': nodeStates[item.name][1]}">[[ item.name ]] </span>
              <v-simple-checkbox v-if="!d_includeExclude" :value="nodeStates[item.name][2]"
                @click="processIncludeExclude(item.name,nodeStates[item.name][2])" class="my-auto" hide-details
                :ripple="false">
              </v-simple-checkbox>
            </div>
          </template>
        </v-treeview>
      </v-navigation-drawer>

      <v-app-bar app>
        <v-app-bar-nav-icon @click="drawer = !drawer"></v-app-bar-nav-icon>
        <v-toolbar-title class="d-flex align-center"><img class="mr-2" width="100"
            src="{{url_for('static', filename = 'img/faser.svg')}}"> RunControl</v-toolbar-title>
        <v-menu offset-y>
          <template v-slot:activator="{ on, attrs }">
            <v-btn v-bind="attrs" :loading="c_configLoading" v-on="on" class="mx-4 my-2" depressed color="primary" small
              :disabled="d_loadConfig">
              load
            </v-btn>
          </template>
          <v-list dense>
            <v-list-item-group>
              <v-list-item v-for="(item, index) in c_configDirs" @click="loadConfig(item)" :key="index">
                <v-list-item-title> [[item]] </v-list-item-title>
              </v-list-item>
            </v-list-item-group>
          </v-list>
        </v-menu>
        <v-spacer></v-spacer>
        <span>[[ whoInterlocked ]]</span>
        <v-btn icon text small class="mx-1" :disabled="!logged">
          <v-icon v-if="locked" @click="interlock()"> mdi-lock-off</v-icon>
          <v-icon v-else @click="interlock()"> mdi-lock</v-icon>
        </v-btn>

        <v-btn icon text small class="mx-1">
          <v-icon v-if="logged" @click="logout"> mdi-account-off</v-icon>
          <v-icon v-else @click="login"> mdi-account</v-icon>
        </v-btn>
        Logged as : {{ usr }}
      </v-app-bar>
      <!-- v-if="resultCommand.includes('ERROR')" -->
      <v-main class="indigo lighten-5">
        <v-alert dense icon="mdi-alert-octagon" prominent class="d-flex align-center mx-4 my-4" color="error">
          <v-row><span class="my-auto mx-3">ERROR: TIMEOUT [[ resultCommand ]] </span>
            <v-btn> FORCE shutdown </v-btn>
            <v-spacer></v-spacer>
            <v-btn icon><v-icon>mdi-close-circle</v-icon></v-btn>
          </v-row>
        </v-alert>
        <v-card :disabled="d_controlPanel" tile elevation="1" class="mx-4 my-4">
          <v-card-title> CONTROL
            <div class="mx-3 d-flex " v-if="c_loadedConfigName">
              <h4>[[ c_loadedConfigName ]]: </h4>
              <v-chip label :color="stateColors[runState]" class="mx-3"> [[ runState ]] </v-chip>
            </div>
          </v-card-title>
          <v-card-text>
            <v-row class="text-center mx-1 my-1">
              <v-btn :loading="processing['INITIALISE']" @click="sendROOTCommand('INITIALISE')"
                :disabled="!isROOTButtonEnabled('INITIALISE')" class="my-1 mx-1" depressed color="success"> INITIALISE
              </v-btn>
              <v-btn :loading="processing['START']" @click="sendROOTCommand('START')" class="my-1 mx-1" depressed
                color="success" :disabled="!isROOTButtonEnabled('START')"> START </v-btn>
              <v-btn :loading="processing['STOP']" @click="sendROOTCommand('STOP')" class="my-1 mx-1" depressed
                color="error" :disabled="!isROOTButtonEnabled('STOP')"> STOP </v-btn>
              <v-btn :loading="processing['SHUTDOWN']" @click="sendROOTCommand('SHUTDOWN')" class="my-1 mx-1" depressed
                color="error" :disabled="!isROOTButtonEnabled('SHUTDOWN')"> SHUTDOWN </v-btn>
              <v-btn :loading="processing['PAUSE']" @click="sendROOTCommand('PAUSE')" class="my-1 mx-1" depressed
                color="yellow darken-2" :disabled="!isROOTButtonEnabled('PAUSE')"> PAUSE </v-btn>
              <v-btn :loading="processing['ECR']" @click="sendROOTCommand('ECR')" class="my-1 mx-1" depressed
                color="success" :disabled="!isROOTButtonEnabled('ECR')"> ECR </v-btn>
            </v-row>
            <v-row class="text-center mx-1 my-1" v-if="isActiveNode()">
              <v-btn :loading="processing['add']" @click="executeCommand('add')"
                :disabled="!fsmRules[getNodeState(activeNode[0].name)].includes('add')" class="my-1 mx-1" depressed
                color="success"> add </v-btn>
              <v-btn :loading="processing['boot']" @click="executeCommand('boot')" class="my-1 mx-1" depressed
                :disabled="!fsmRules[getNodeState(activeNode[0].name)].includes('boot')" color="success"> boot </v-btn>
              <v-btn :loading="processing['configure']" @click="executeCommand('configure')" class="my-1 mx-1" depressed
                :disabled="!fsmRules[getNodeState(activeNode[0].name)].includes('configure')" color="success"> configure
              </v-btn>
              <v-btn :loading="processing['start']" @click="executeCommand('start')" class="my-1 mx-1" depressed
                :disabled="!fsmRules[getNodeState(activeNode[0].name)].includes('start')" color="success"> start
              </v-btn>
              <v-btn :loading="processing['stop']" @click="executeCommand('stop')" class="my-1 mx-1" depressed
                :disabled="!fsmRules[getNodeState(activeNode[0].name)].includes('stop')" color="yellow darken-2"> stop
              </v-btn>
              <v-btn :loading="processing['unconfigure']" @click="executeCommand('unconfigure')" class="my-1 mx-1"
                depressed :disabled="!fsmRules[getNodeState(activeNode[0].name)].includes('unconfigure')"
                color="success"> unconfigure </v-btn>
              <v-btn :loading="processing['shutdown']" @click="executeCommand('shutdown')" class="my-1 mx-1" depressed
                :disabled="!fsmRules[getNodeState(activeNode[0].name)].includes('shutdown')" color="success"> shutdown
              </v-btn>
              <v-btn :loading="processing['remove']" @click="executeCommand('remove')" class="my-1 mx-1" depressed
                :disabled="!fsmRules[getNodeState(activeNode[0].name)].includes('remove')" color="success"> remove
              </v-btn>
            </v-row>
          </v-card-text>
        </v-card>

        <v-card tile elevation="1" class="mx-4 my-4" v-if="infoIsActive && isActiveNode() && !hasChildren(activeNode)">
          <v-card-title> Module information : [[ activeNode[0].name ]] <v-spacer></v-spacer>
            <v-btn @click="openInfoInNewWindow()" icon color="normal">
              <v-icon>mdi-open-in-new</v-icon>
            </v-btn>
          </v-card-title>
          <v-card-text class="scrollableDiv">
            <info_panel :module="activeNode[0].name"></info_panel>
          </v-card-text>
        </v-card>

        <v-card tile elevation="1" class="mx-4 my-4">
          <v-card-title> MONITORING <span class="mx-3" v-if="isActiveNode() ? !hasChildren(activeNode) : false">
              <v-menu offset-y>
                <template v-slot:activator="{ on, attrs }">
                  <v-btn depressed small dark color="teal" v-bind="attrs" v-on="on"> LOG </v-btn>
                </template>
                <v-list>
                  <v-list-item @click="openLogWindow()" :key="0">
                    <v-list-item-title>Live log</v-list-item-title>
                  </v-list-item>
                  <v-list-item :key="1" @click="openFullLog()">
                    <v-list-item-title>Full log</v-list-item-title>
                  </v-list-item>
                </v-list>
              </v-menu>
              <v-btn @click="infoIsActive= !infoIsActive" depressed small dark color="teal"> INFO </v-btn>
            </span>
          </v-card-title>
          <v-card-text>
            <monitoring_panel :p_on="runOnGoing"></monitoring_panel>
          </v-card-text>
        </v-card>

        <v-card tile elevation="1" class="mx-4 my-4">
          <v-card-title> LOG </v-card-title>
          <v-card-text width="170" class="scrollableDiv">
            <div v-for="(line,index) in log.slice().reverse()" :key="index"> [[line]]</div>
          </v-card-text>
        </v-card>
      </v-main>
    </v-app>
  </div>
</body>

</html>